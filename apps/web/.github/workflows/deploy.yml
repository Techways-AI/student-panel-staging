name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: apps/web/package-lock.json
        
    - name: ğŸ§¹ Clear all caches
      run: |
        cd apps/web
        rm -rf .next .swc out node_modules/.cache .tsbuildinfo
        npm cache clean --force
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd apps/web
        npm ci --only=production
        
    - name: ğŸ” Verify CourseContent files
      run: |
        cd apps/web
        echo "Checking CourseContent files..."
        ls -la src/components/CourseContent*
        echo "âœ… CourseContent files verified"
        
    - name: ğŸ—ï¸ Build application
      run: |
        cd apps/web
        export NODE_ENV=production
        export NEXT_TELEMETRY_DISABLED=1
        export NODE_OPTIONS="--max-old-space-size=8192"
        npm run build
        
    - name: ğŸ§ª Test build output
      run: |
        cd apps/web
        if [ -d ".next" ]; then
          echo "âœ… Build successful - .next directory exists"
          ls -la .next/
        else
          echo "âŒ Build failed - .next directory missing"
          exit 1
        fi
        
    - name: ğŸ“Š Build size analysis
      run: |
        cd apps/web
        echo "ğŸ“Š Build Size Report:"
        du -sh .next/static/* || echo "No static files found"
        echo "ğŸ“‹ Static files:"
        find .next/static -type f -name "*.js" -o -name "*.css" | head -10
        
    - name: ğŸš€ Deploy (placeholder)
      run: |
        echo "ğŸš€ Ready for deployment!"
        echo "Build completed successfully with fresh cache"
        echo "CourseContent changes included âœ…"
        
  # Additional job for testing different environments
  test-deployment:
    runs-on: windows-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: ğŸ§¹ Windows cache clear
      run: |
        cd apps/web
        if (Test-Path .next) { Remove-Item .next -Recurse -Force }
        if (Test-Path .swc) { Remove-Item .swc -Recurse -Force }
        if (Test-Path out) { Remove-Item out -Recurse -Force }
        npm cache clean --force
        
    - name: ğŸ“¦ Install and build
      run: |
        cd apps/web
        npm ci --only=production
        $env:NODE_ENV="production"
        $env:NEXT_TELEMETRY_DISABLED="1"
        npm run build
        
    - name: âœ… Verify Windows build
      run: |
        cd apps/web
        if (Test-Path .next) {
          Write-Host "âœ… Windows build successful"
        } else {
          Write-Host "âŒ Windows build failed"
          exit 1
        }

